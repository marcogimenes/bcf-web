<div class="content content-detail">
  <div class="settings-box">
    <div class="settings-header">
      <div class="title-row">
        <h5>Configurações</h5>
      </div>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link clickable"
            [ngClass]="{ active: tab == 'dashboard' }"
            (click)="changeTab('dashboard')"
            role="tab"
            aria-controls="dashboard"
            aria-selected="true"
          >
            Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link clickable"
            [ngClass]="{ active: tab == 'general' }"
            (click)="changeTab('general')"
            role="tab"
            aria-controls="general"
            aria-selected="false"
          >
            Geral
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link clickable"
            [ngClass]="{ active: tab == 'debug_monitoring' }"
            (click)="changeTab('debug_monitoring')"
            role="tab"
            aria-controls="debug_monitoring"
            aria-selected="false"
          >
            Verificar Atendimento
          </a>
        </li>
      </ul>
    </div>
    <div class="settings-body">
      <div class="tab-content">
        <div
          *ngIf="tab == 'dashboard'"
          class="tab-pane fade"
          [ngClass]="{ 'show active': tab == 'dashboard' }"
          id="dashboard"
          role="tabpanel"
          aria-labelledby="dashboard-tab"
        >
          <form *ngIf="formPlace1" [formGroup]="formPlace1">
            <span class="place">Local 1</span>
            <div class="settings-form">
              <div class="settings-param">
                <span class="settings-param-title">Base</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="baseItems"
                  formControlName="base"
                  bindValue="value"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param">
                <span class="settings-param-title">Setor</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[0].setores_hosp"
                  [loading]="placeItems[0].setores_hosp_loading"
                  formControlName="setor_hosp"
                  notFoundText="Não há setores"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Unidade</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[0].unidades_atendimento"
                  [loading]="placeItems[0].unidades_atendimento_loading"
                  [virtualScroll]="true"
                  formControlName="unidade_atendimento"
                  notFoundText="Não há unidades de atendimento"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Posto</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[0].postos"
                  [loading]="placeItems[0].postos_loading"
                  [virtualScroll]="true"
                  formControlName="posto"
                  notFoundText="Não há postos"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
            </div>
          </form>
          <form *ngIf="formPlace2" [formGroup]="formPlace2">
            <span class="place">Local 2</span>
            <div class="settings-form">
              <div class="settings-param">
                <span class="settings-param-title">Base</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="baseItems"
                  formControlName="base"
                  bindValue="value"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param">
                <span class="settings-param-title">Setor</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[1].setores_hosp"
                  [loading]="placeItems[1].setores_hosp_loading"
                  formControlName="setor_hosp"
                  notFoundText="Não há setores"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Unidade</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[1].unidades_atendimento"
                  [loading]="placeItems[1].unidades_atendimento_loading"
                  [virtualScroll]="true"
                  formControlName="unidade_atendimento"
                  notFoundText="Não há unidades de atendimento"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Posto</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[1].postos"
                  [loading]="placeItems[1].postos_loading"
                  [virtualScroll]="true"
                  formControlName="posto"
                  notFoundText="Não há postos"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
            </div>
          </form>
          <form *ngIf="formPlace3" [formGroup]="formPlace3">
            <span class="place">Local 3</span>
            <div class="settings-form">
              <div class="settings-param">
                <span class="settings-param-title">Base</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="baseItems"
                  formControlName="base"
                  bindValue="value"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param">
                <span class="settings-param-title">Setor</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[2].setores_hosp"
                  [loading]="placeItems[2].setores_hosp_loading"
                  formControlName="setor_hosp"
                  notFoundText="Não há setores"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Unidade</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[2].unidades_atendimento"
                  [loading]="placeItems[2].unidades_atendimento_loading"
                  [virtualScroll]="true"
                  formControlName="unidade_atendimento"
                  notFoundText="Não há unidades de atendimento"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Posto</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[2].postos"
                  [loading]="placeItems[2].postos_loading"
                  [virtualScroll]="true"
                  formControlName="posto"
                  notFoundText="Não há postos"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
            </div>
          </form>
          <form *ngIf="formPlace4" [formGroup]="formPlace4">
            <span class="place">Local 4</span>
            <div class="settings-form">
              <div class="settings-param">
                <span class="settings-param-title">Base</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="baseItems"
                  formControlName="base"
                  bindValue="value"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param">
                <span class="settings-param-title">Setor</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[3].setores_hosp"
                  [loading]="placeItems[3].setores_hosp_loading"
                  formControlName="setor_hosp"
                  notFoundText="Não há setores"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Unidade</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[3].unidades_atendimento"
                  [loading]="placeItems[3].unidades_atendimento_loading"
                  [virtualScroll]="true"
                  formControlName="unidade_atendimento"
                  notFoundText="Não há unidades de atendimento"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Posto</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[3].postos"
                  [loading]="placeItems[3].postos_loading"
                  [virtualScroll]="true"
                  formControlName="posto"
                  notFoundText="Não há postos"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
            </div>
          </form>
          <form *ngIf="formPlace5" [formGroup]="formPlace5">
            <span class="place">Local 5</span>
            <div class="settings-form">
              <div class="settings-param">
                <span class="settings-param-title">Base</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="baseItems"
                  formControlName="base"
                  bindValue="value"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param">
                <span class="settings-param-title">Setor</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[4].setores_hosp"
                  [loading]="placeItems[4].setores_hosp_loading"
                  formControlName="setor_hosp"
                  notFoundText="Não há setores"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Unidade</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[4].unidades_atendimento"
                  [loading]="placeItems[4].unidades_atendimento_loading"
                  [virtualScroll]="true"
                  formControlName="unidade_atendimento"
                  notFoundText="Não há unidades de atendimento"
                  placeholder="Não selecionada">
                </ng-select>
              </div>
              <div class="settings-param flex-grow-1">
                <span class="settings-param-title">Posto</span>
                <ng-select
                  class="settings-param-input select2-custom"
                  [items]="placeItems[4].postos"
                  [loading]="placeItems[4].postos_loading"
                  [virtualScroll]="true"
                  formControlName="posto"
                  notFoundText="Não há postos"
                  placeholder="Não selecionado">
                </ng-select>
              </div>
            </div>
          </form>
          <form *ngIf="screenSettingsForm" [formGroup]="screenSettingsForm">
            <div class="form-group-horizontal">
              <div class="form-group-horizontal-type">Configurações de Tela</div>
              <div class="form-group-horizontal-params">
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Escala do gráfico
                  </div>
                  <div class="form-group-param-field">
                    <input formControlName="graf_escala" type="number" />
                    <span class="unit">cm/min</span>
                  </div>
                </div>
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Tamanho da tela (polegadas)
                  </div>
                  <div class="form-group-param-field">
                    <input formControlName="tela_polegadas" type="number" />
                    <span class="unit">pol</span>
                  </div>
                </div>
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Resolução Horizontal
                  </div>
                  <div class="form-group-param-field">
                    <input formControlName="tela_resh" type="number" />
                    <span class="unit">px</span>
                  </div>
                </div>
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Resolução Vertical
                  </div>
                  <div class="form-group-param-field">
                    <input formControlName="tela_resv" type="number" />
                    <span class="unit">px</span>
                  </div>
                </div>
              </div>
            </div>
          </form>
          <button type="button" class="btn-default" title="Tocar alerta sonoro" (click)="emitSoundAlert()">
            <i class="fas fa-bullhorn"></i>&nbsp;Testar alerta sonoro
          </button>
          <div class="mt-4">
            <button class="btn-default btn-hover-to-primary-outline btn-settings mr-2" (click)="resetSettingsGeneralTab()">
              Restaurar
            </button>
            <button
              class="btn-default btn-primary btn-settings"
              [disabled]="!screenSettingsForm?.valid || !(formPlace1?.valid || formPlace2?.valid || formPlace3?.valid || formPlace4?.valid || formPlace5?.valid)"
              (click)="saveSettingsGeneralTab()"
            >
              Aplicar
            </button>
          </div>
        </div>
        <div
          *ngIf="tab == 'general'"
          class="tab-pane fade"
          [ngClass]="{ 'show active': tab == 'general' }"
          id="general"
          role="tabpanel"
          aria-labelledby="general-tab"
        >
          <form *ngIf="!authenticatedUser" [formGroup]="loginForm">
            <div class="form-group-horizontal">
              <div class="form-group-horizontal-type__description">
                Para efetuar edições de alerta é necessário estar autenticado
              </div>
              <div *ngIf="loginForm.errors" class="form-group-horizontal-type__description error">
                * Não foi possível realizar o login com as credenciais fornecidas
              </div>
              <div class="form-group-horizontal-params">
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Login
                  </div>
                  <div class="form-group-param-field" [ngClass]="{ error: loginForm.errors }">
                    <input formControlName="username" type="text" />
                    <span class="unit"><i class="fas fa-user"></i></span>
                  </div>
                </div>
                <div class="form-group-param">
                  <div class="form-group-param-description">
                    Senha
                  </div>
                  <div class="form-group-param-field" [ngClass]="{ error: loginForm.errors }">
                    <input formControlName="password" type="password" />
                    <span class="unit"><i class="fas fa-lock"></i></span>
                  </div>
                </div>
                <div class="form-group-param">
                  <div class="form-group-param-description"></div>
                  <div>
                    <button
                      class="button button__primary"
                      [disabled]="!loginForm.valid"
                      (click)="login()"
                    >
                      Autenticar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <!-- Usuário logado-->
          <div *ngIf="authenticatedUser" class="auth-box">
            <div class="form">
              <span
                >Bem vindo
                <b>{{
                  authenticatedUser.first_name
                    ? authenticatedUser.first_name
                    : authenticatedUser.username
                }}</b></span
              >
              <button class="button button__primary" (click)="logout()">Sair</button>
            </div>
          </div>

          <form *ngIf="settings_form" [formGroup]="settings_form">
            <div class="form-group-horizontal" *ngFor="let group of settings_grouped_list | keyvalue">
              <div class="form-group-horizontal-type">
                {{ group?.key !== 'null' && group?.key !== null && group?.key !== '' ? group?.key : 'Geral' }}
              </div>
              <div class="form-group-horizontal-params">
                <div class="form-group-param" *ngFor="let setting of group.value">
                  <div class="form-group-param-description">
                    {{ setting?.descricao || '-' }}
                  </div>
                  <div class="form-group-param-field">
                    <input [attr.disabled]="!authenticatedUser ? '' : null" [formControlName]="setting?.nome" type="number"/>
                    <span class="unit">{{ unidade_map[(setting?.unidade)] || '-' }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <button
                class="btn-default btn-hover-to-primary-outline btn-settings mr-2"
                (click)="resetSettingsAlertaTab()"
                [disabled]="!authenticatedUser"
              >
                Restaurar
              </button>
              <button
                type="submit"
                class="btn-default btn-primary btn-settings"
                [disabled]="!settings_form?.valid || !authenticatedUser || !settings_list.length"
                (click)="saveSettingsAlertaTab()"
              >
                Aplicar
              </button>
            </div>
          </form>
        </div>
        <div
          *ngIf="tab == 'debug_monitoring'"
          class="tab-pane fade debug_section"
          [ngClass]="{ 'show active': tab == 'debug_monitoring' }"
          id="debug_monitoring"
          role="tabpanel"
          aria-labelledby="debug_monitoring-tab"
        >
          <div class="filter-box">
            <div class="filter-box__body d-flex justify-content-between align-items-center">
              <div class="filter-item">
                Número do Atendimento
              </div>
              <input
                type="number"
                class="filter-item form-control"
                [(ngModel)]="attendance_code"
                (keyup.enter)="debug_monitoring()"
                autofocus
              />
              <button
                type="button"
                class="btn-default btn-primary-outline form-control filter-item"
                (click)="debug_monitoring()"
              >
                <i class="fa fa-search"></i>&nbsp;Pesquisar
              </button>
            </div>
          </div>
          <div class="validations">
            <div *ngFor="let validation of debug_validations">
              <div
                *ngIf="validation.status"
                class="card"
                [ngClass]="{
                  success: validation.status === 'ok',
                  error: validation.status === 'error'
                }"
              >
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="title">{{ validation.title }}</span>
                    <i
                      [ngClass]="{
                        'fa fa-check-circle': validation.status === 'ok',
                        'fas fa-exclamation-circle': validation.status === 'error'
                      }"
                      class=""
                    ></i>
                  </div>
                  <ul *ngIf="validation.steps.length">
                    <li *ngFor="let step of validation.steps">
                      {{ step.name }}.....{{ step.status }}
                    </li>
                  </ul>
                  <p
                    [innerHTML]="validation.msg_error"
                    class="card-text"
                    *ngIf="validation.msg_error"
                  ></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" [ngClass]="{ 'overlay-show': loading }">
    <div *ngIf="loading" class="lds-ring">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>
</div>

<ng-template #setorTemplate let-model="item" let-index="index">
  {{model.nm_setor_hosp}}
</ng-template>

<ng-template #unidadeTemplate let-model="item" let-index="index">
  {{model.nm_unidade_atendimento}}
</ng-template>

<ng-template #postoTemplate let-model="item" let-index="index">
  {{model.nm_setor}}
</ng-template>
